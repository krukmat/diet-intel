============================= test session starts ==============================
platform darwin -- Python 3.9.10, pytest-8.4.2, pluggy-1.6.0
benchmark: 4.0.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /Users/matiasleandrokruk/Documents/DietIntel
configfile: pytest.ini
plugins: Faker-19.6.2, integration-0.2.3, httpx-0.35.0, cov-4.1.0, asyncio-0.21.1, xdist-3.3.0, mock-3.12.0, anyio-3.7.1, recording-0.12.2, benchmark-4.0.0
asyncio: mode=strict
collected 17 items

tests/social/test_feed_ingester.py ..........                            [ 58%]
tests/social/test_feed_routes.py FFFFFFF                                 [100%]

=================================== FAILURES ===================================
_____________________ TestFeedRoutes.test_get_feed_success _____________________

self = <test_feed_routes.TestFeedRoutes object at 0x167b70850>
client = <starlette.testclient.TestClient object at 0x167e18ac0>
auth_headers = {'Authorization': 'Bearer mock_token'}

    def test_get_feed_success(self, client, auth_headers):
        """Test successful feed retrieval"""
        # Mock feed data
        mock_feed_response = FeedResponse(
            items=[
                FeedItem(
                    id="feed-1",
                    user_id="user2",
                    actor_id="test-user-123",
                    event_name="UserAction.UserFollowed",
                    payload={"follower_id": "test-user-123", "target_id": "user2", "action": "followed", "ts": "2025-01-01T10:00:00Z"},
                    created_at="2025-01-01T10:00:00Z"
                )
            ],
            next_cursor="next-cursor-token"
        )
    
        with patch('app.services.auth.auth_service.get_current_user_from_token', AsyncMock(return_value=MagicMock(id="test-user-123"))):
            with patch('app.routes.feed.list_feed') as mock_list_feed:
                mock_list_feed.return_value = mock_feed_response
    
                response = client.get("/feed", headers=auth_headers)
    
>           assert response.status_code == 200
E           assert 404 == 200
E            +  where 404 = <Response [404 Not Found]>.status_code

tests/social/test_feed_routes.py:44: AssertionError
_________________ TestFeedRoutes.test_get_feed_with_pagination _________________

self = <test_feed_routes.TestFeedRoutes object at 0x167bb5160>
client = <starlette.testclient.TestClient object at 0x167e67550>
auth_headers = {'Authorization': 'Bearer mock_token'}

    def test_get_feed_with_pagination(self, client, auth_headers):
        """Test feed retrieval with pagination parameters"""
        with patch('app.services.auth.auth_service.get_current_user_from_token', AsyncMock(return_value=MagicMock(id="test-user-123"))):
            with patch('app.routes.feed.list_feed') as mock_list_feed:
                mock_list_feed.return_value = FeedResponse(items=[], next_cursor=None)
    
                # Test with limit and cursor
                response = client.get("/feed?limit=50&cursor=pagination-token", headers=auth_headers)
    
>           assert response.status_code == 200
E           assert 404 == 200
E            +  where 404 = <Response [404 Not Found]>.status_code

tests/social/test_feed_routes.py:69: AssertionError
________________ TestFeedRoutes.test_get_feed_limit_validation _________________

self = <test_feed_routes.TestFeedRoutes object at 0x167bbef40>
client = <starlette.testclient.TestClient object at 0x167e89fd0>
auth_headers = {'Authorization': 'Bearer mock_token'}

    def test_get_feed_limit_validation(self, client, auth_headers):
        """Test limit parameter validation"""
        # Test minimum limit
        response = client.get("/feed?limit=0", headers=auth_headers)
>       assert response.status_code == 422  # Validation error
E       assert 404 == 422
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/social/test_feed_routes.py:82: AssertionError
_________________ TestFeedRoutes.test_get_feed_unauthenticated _________________

self = <test_feed_routes.TestFeedRoutes object at 0x167bd7280>
client = <starlette.testclient.TestClient object at 0x167dd00d0>

    def test_get_feed_unauthenticated(self, client):
        """Test feed endpoint requires authentication"""
        response = client.get("/feed")
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/social/test_feed_routes.py:99: AssertionError
___________________ TestFeedRoutes.test_get_feed_empty_feed ____________________

self = <test_feed_routes.TestFeedRoutes object at 0x167bd7dc0>
client = <starlette.testclient.TestClient object at 0x167e98730>
auth_headers = {'Authorization': 'Bearer mock_token'}

    def test_get_feed_empty_feed(self, client, auth_headers):
        """Test feed with no activity"""
        empty_response = FeedResponse(items=[], next_cursor=None)
    
        with patch('app.services.auth.auth_service.get_current_user_from_token', AsyncMock(return_value=MagicMock(id="test-user-123"))):
            with patch('app.routes.feed.list_feed') as mock_list_feed:
                mock_list_feed.return_value = empty_response
    
                response = client.get("/feed", headers=auth_headers)
    
>           assert response.status_code == 200
E           assert 404 == 200
E            +  where 404 = <Response [404 Not Found]>.status_code

tests/social/test_feed_routes.py:111: AssertionError
__________________ TestFeedRoutes.test_get_feed_service_error __________________

self = <test_feed_routes.TestFeedRoutes object at 0x167be2130>
client = <starlette.testclient.TestClient object at 0x167e67b80>
auth_headers = {'Authorization': 'Bearer mock_token'}

    def test_get_feed_service_error(self, client, auth_headers):
        """Test handling of service errors"""
        with patch('app.services.auth.auth_service.get_current_user_from_token', AsyncMock(return_value=MagicMock(id="test-user-123"))):
            with patch('app.routes.feed.list_feed') as mock_list_feed:
                mock_list_feed.side_effect = Exception("Service error")
    
                response = client.get("/feed", headers=auth_headers)
    
                # Should still return 200 with empty feed on service errors
>               assert response.status_code == 200
E               assert 404 == 200
E                +  where 404 = <Response [404 Not Found]>.status_code

tests/social/test_feed_routes.py:125: AssertionError
________________ TestFeedRoutes.test_feed_disabled_feature_flag ________________

self = <test_feed_routes.TestFeedRoutes object at 0x167be2460>
client = <starlette.testclient.TestClient object at 0x167de4160>
auth_headers = {'Authorization': 'Bearer mock_token'}

    def test_feed_disabled_feature_flag(self, client, auth_headers):
        """Test feed is disabled when feature flag is off"""
        with patch('app.services.auth.auth_service.get_current_user_from_token', AsyncMock(return_value=MagicMock(id="test-user-123"))):
            with patch('app.routes.feed.assert_feature_enabled') as mock_assert:
                mock_assert.side_effect = HTTPException(status_code=404, detail="Feature disabled")
    
                response = client.get("/feed", headers=auth_headers)
    
                assert response.status_code == 404
>               assert "Feature disabled" in response.text
E               assert 'Feature disabled' in '{"detail":"Not Found"}'
E                +  where '{"detail":"Not Found"}' = <Response [404 Not Found]>.text

tests/social/test_feed_routes.py:139: AssertionError
=============================== warnings summary ===============================
app/models/user.py:26
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/user.py:26: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('email')

app/models/product.py:9
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/product.py:9: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator("barcode")

app/models/tracking.py:13
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/tracking.py:13: PydanticDeprecatedSince20: Pydantic V1 style `@root_validator` validators are deprecated. You should migrate to Pydantic V2 style `@model_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @root_validator(pre=True)

../../miniforge3/lib/python3.9/site-packages/pydantic/fields.py:768: 10 warnings
  /Users/matiasleandrokruk/miniforge3/lib/python3.9/site-packages/pydantic/fields.py:768: PydanticDeprecatedSince20: `min_items` is deprecated and will be removed, use `min_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warn('`min_items` is deprecated and will be removed, use `min_length` instead', DeprecationWarning)

../../miniforge3/lib/python3.9/site-packages/pydantic/fields.py:774
../../miniforge3/lib/python3.9/site-packages/pydantic/fields.py:774
../../miniforge3/lib/python3.9/site-packages/pydantic/fields.py:774
../../miniforge3/lib/python3.9/site-packages/pydantic/fields.py:774
../../miniforge3/lib/python3.9/site-packages/pydantic/fields.py:774
../../miniforge3/lib/python3.9/site-packages/pydantic/fields.py:774
../../miniforge3/lib/python3.9/site-packages/pydantic/fields.py:774
  /Users/matiasleandrokruk/miniforge3/lib/python3.9/site-packages/pydantic/fields.py:774: PydanticDeprecatedSince20: `max_items` is deprecated and will be removed, use `max_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warn('`max_items` is deprecated and will be removed, use `max_length` instead', DeprecationWarning)

app/models/tracking.py:63
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/tracking.py:63: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('timestamp')

app/models/tracking.py:93
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/tracking.py:93: PydanticDeprecatedSince20: Pydantic V1 style `@root_validator` validators are deprecated. You should migrate to Pydantic V2 style `@model_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @root_validator(pre=True)

app/models/tracking.py:113
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/tracking.py:113: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('date')

../../miniforge3/lib/python3.9/site-packages/pydantic/_internal/_config.py:268
  /Users/matiasleandrokruk/miniforge3/lib/python3.9/site-packages/pydantic/_internal/_config.py:268: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

app/models/recipe.py:89
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/recipe.py:89: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('cuisine_preferences')

app/models/recipe.py:95
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/recipe.py:95: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('dietary_restrictions')

app/models/shopping.py:102
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/shopping.py:102: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('source_recipes', pre=True)

app/models/shopping.py:139
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/shopping.py:139: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('immediate_savings', 'cost_per_unit_savings')

app/models/shopping.py:238
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/shopping.py:238: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('recipe_ids')

app/models/shopping.py:286
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/shopping.py:286: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('optimization_name', pre=True, always=True)

app/models/translation.py:16
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/translation.py:16: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('text')

app/models/translation.py:22
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/translation.py:22: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('source_lang', 'target_lang')

app/models/translation.py:42
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/translation.py:42: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('texts')

app/models/translation.py:58
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/translation.py:58: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('source_lang', 'target_lang')

app/models/translation.py:72
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/translation.py:72: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('food_names')

app/models/translation.py:88
  /Users/matiasleandrokruk/Documents/DietIntel/app/models/translation.py:88: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('source_lang', 'target_lang')

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/social/test_feed_routes.py::TestFeedRoutes::test_get_feed_success
FAILED tests/social/test_feed_routes.py::TestFeedRoutes::test_get_feed_with_pagination
FAILED tests/social/test_feed_routes.py::TestFeedRoutes::test_get_feed_limit_validation
FAILED tests/social/test_feed_routes.py::TestFeedRoutes::test_get_feed_unauthenticated
FAILED tests/social/test_feed_routes.py::TestFeedRoutes::test_get_feed_empty_feed
FAILED tests/social/test_feed_routes.py::TestFeedRoutes::test_get_feed_service_error
FAILED tests/social/test_feed_routes.py::TestFeedRoutes::test_feed_disabled_feature_flag
================== 7 failed, 10 passed, 36 warnings in 2.39s ===================
