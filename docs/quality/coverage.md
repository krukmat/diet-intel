# Coverage

This document consolidates coverage planning notes so the “what/why” lives in one place.

## Source Of Truth

- Latest coverage sweep output: `coverage.json` (generated by `python -m pytest --cov=app`).

## Coverage Improvement Proposals (Dec 2025)

Estos apuntes describen la estrategia aplicada para subir la cobertura de los módulos que estaban por debajo del 50 %:

### `app/routes/block.py`
- Simular `ValidationError`/`RuntimeError` para cubrir handlers `422`/`500`.
- Cubrir `POST /blocks/{target_id}` con `action="unblock"`.
- Forzar excepciones en `list_blocked`/`list_blockers` sin tocar DB real.

### `app/routes/recommendations.py`
- Feedback extremo: `record_feedback=False` → `HTTPException(500)`.
- Métricas: validaciones de `days`, ruta feliz y ruta de excepción en `GET /recommendations/metrics`.
- Preferencias: éxito, denegación, ausencia (404) y falla del motor (500) en `/user-preferences/{user_id}`.

### `app/services/smart_diet.py`
- Hash determinista: `_generate_request_hash`.
- Ramas de traducción (incl. fallback): `_generate_insights`, `_generate_nutritional_summary`.
- Optimización: sin plan (corta) y con plan (llama `OptimizationEngine`).
- Feedback/insights: `process_suggestion_feedback`, `get_diet_insights`.

### `app/routes/posts.py`
- Éxito/errores para listados, reacciones y comentarios (incl. `ValueError`).

### `app/services/translation_service.py`
- Respuestas JSON/texto plano y errores (timeout/500) en `_translate_with_libretranslate`.
- Singleton/formatos: `get_supported_languages`, `is_language_supported`, `get_translation_service`.
- Caching con `_MemoryCache` (sin dependencias externas).

## Medium-Coverage Targets (50–60%)

Small remaining group after the last sweep; prioritizing these helps push the next global run toward 80%.

- `app/services/database.py` (~60%) — exercise rollbacks and `OperationalError`/`IntegrityError` handling; validate cache fallbacks.
- `app/services/smart_diet_cache.py` (~61%) — TTL misses, invalidation flows, serialization failures.
- `app/services/smart_diet_optimized.py` (~60%) — Redis unavailable, empty optimization outputs, fallback planning.

## How To Run

```bash
python -m pytest --cov=app
```
