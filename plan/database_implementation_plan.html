<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DietIntel - Database Layer Implementation Plan</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 1.2em;
            margin-top: 10px;
            opacity: 0.9;
        }
        
        .section {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #667eea;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .section h3 {
            color: #495057;
            margin-top: 25px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .status-card {
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .status-connected {
            background-color: #d4edda;
            border-color: #28a745;
        }
        
        .status-memory {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        
        .status-cache {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
        }
        
        .code-block pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
        
        .phase-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .phase-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .phase-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .benefits {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .benefits h4 {
            color: #155724;
            margin-top: 0;
        }
        
        .benefits ul {
            margin: 10px 0;
        }
        
        .benefits li {
            margin: 5px 0;
        }
        
        .meta-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .emoji {
            font-size: 1.2em;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üóÑÔ∏è Database Layer Implementation Plan</h1>
        <div class="subtitle">DietIntel API - Migration from Cache to Persistent Storage</div>
        <div class="subtitle">Generated: September 1, 2025</div>
    </div>

    <div class="section">
        <h2>üìä Current State Analysis</h2>
        
        <h3><span class="emoji">‚úÖ</span>What's Already Connected to Database</h3>
        <div class="status-card status-connected">
            <strong>Auth Routes (/auth/*)</strong> - Fully integrated with SQLite database
            <ul>
                <li>Users table with complete schema</li>
                <li>User sessions table for JWT management</li>
                <li>All CRUD operations implemented in DatabaseService</li>
            </ul>
        </div>

        <h3><span class="emoji">üî¥</span>What's Using In-Memory/Cache Storage</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Route Module</th>
                        <th>Current Storage</th>
                        <th>Impact</th>
                        <th>Persistence</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Tracking Routes</strong> (/track/*)</td>
                        <td>In-memory arrays + Redis cache</td>
                        <td>Data lost on restart</td>
                        <td>24h TTL</td>
                    </tr>
                    <tr>
                        <td><strong>Reminder Routes</strong> (/reminder/*)</td>
                        <td>In-memory arrays + Redis cache</td>
                        <td>Data lost on restart</td>
                        <td>24h TTL</td>
                    </tr>
                    <tr>
                        <td><strong>Product Routes</strong> (/product/*)</td>
                        <td>Redis cache only</td>
                        <td>API calls repeated</td>
                        <td>24h TTL</td>
                    </tr>
                    <tr>
                        <td><strong>Plan Routes</strong> (/plan/*)</td>
                        <td>Redis cache only</td>
                        <td>Plans lost after TTL</td>
                        <td>24h TTL</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h3><span class="emoji">üîç</span>Current Architecture Issues</h3>
        
        <div class="highlight">
            <strong>1. Data Persistence Gap</strong>
            <div class="code-block">
                <pre># Track routes - line 20-21
meal_tracking_data = []      # Lost on restart
weight_tracking_data = []    # Lost on restart</pre>
            </div>
        </div>

        <div class="highlight">
            <strong>2. Mixed Storage Patterns</strong>
            <ul>
                <li>Auth: SQLite database (persistent)</li>
                <li>Everything else: In-memory + Redis cache (temporary)</li>
            </ul>
        </div>

        <div class="highlight">
            <strong>3. Production Readiness</strong>
            <ul>
                <li>Comments throughout codebase: "replace with database in production"</li>
                <li>Redis used only for caching, not primary storage</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>üöÄ Database Integration Plan</h2>

        <div class="phase-card">
            <div class="phase-header">
                <div class="phase-number">1</div>
                <h3>Database Schema Design üìä</h3>
            </div>
            
            <strong>New Tables Required:</strong>
            <div class="code-block">
                <pre>-- Meal tracking
CREATE TABLE meals (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    meal_name TEXT NOT NULL,
    total_calories REAL NOT NULL,
    photo_url TEXT,
    timestamp TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id)
);

CREATE TABLE meal_items (
    id TEXT PRIMARY KEY,
    meal_id TEXT NOT NULL,
    barcode TEXT NOT NULL,
    name TEXT NOT NULL,
    serving TEXT NOT NULL,
    calories REAL NOT NULL,
    macros TEXT NOT NULL, -- JSON
    FOREIGN KEY (meal_id) REFERENCES meals (id) ON DELETE CASCADE
);

-- Weight tracking  
CREATE TABLE weight_entries (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    weight REAL NOT NULL,
    date TIMESTAMP NOT NULL,
    photo_url TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id)
);

-- Reminders
CREATE TABLE reminders (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    reminder_time TIMESTAMP NOT NULL,
    frequency TEXT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    last_triggered TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id)
);

-- Meal plans (persistent storage)
CREATE TABLE meal_plans (
    id TEXT PRIMARY KEY,
    user_id TEXT,
    plan_data TEXT NOT NULL, -- JSON
    bmr REAL NOT NULL,
    tdee REAL NOT NULL,
    daily_calorie_target REAL NOT NULL,
    flexibility_used BOOLEAN DEFAULT FALSE,
    optional_products_used INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP -- TTL equivalent
);</pre>
            </div>
        </div>

        <div class="phase-card">
            <div class="phase-header">
                <div class="phase-number">2</div>
                <h3>Service Layer Extensions üîß</h3>
            </div>
            
            <strong>Extend DatabaseService with new methods:</strong>
            <div class="code-block">
                <pre>class DatabaseService:
    # Existing auth methods...
    
    # Meal tracking
    async def create_meal(self, user_id: str, meal_data: MealTrackingRequest) -> str
    async def get_user_meals(self, user_id: str, limit: int = 50) -> List[Dict]
    async def get_meal_by_id(self, meal_id: str) -> Optional[Dict]
    
    # Weight tracking
    async def create_weight_entry(self, user_id: str, weight_data: WeightTrackingRequest) -> str
    async def get_user_weight_history(self, user_id: str, limit: int = 30) -> List[Dict]
    
    # Reminders  
    async def create_reminder(self, user_id: str, reminder_data: ReminderRequest) -> str
    async def get_user_reminders(self, user_id: str) -> List[Dict]
    async def update_reminder(self, reminder_id: str, updates: Dict) -> bool
    async def delete_reminder(self, reminder_id: str) -> bool
    
    # Meal plans
    async def store_meal_plan(self, user_id: str, plan: MealPlanResponse) -> str
    async def get_meal_plan(self, plan_id: str) -> Optional[Dict]
    async def update_meal_plan(self, plan_id: str, plan: MealPlanResponse) -> bool
    async def delete_meal_plan(self, plan_id: str) -> bool</pre>
            </div>
        </div>

        <div class="phase-card">
            <div class="phase-header">
                <div class="phase-number">3</div>
                <h3>Route Handler Migration üîÑ</h3>
            </div>
            
            <strong>Update Strategy:</strong>
            <ul>
                <li>Replace in-memory arrays with database calls</li>
                <li>Keep Redis for caching frequently accessed data</li>
                <li>Add user authentication context to all operations</li>
                <li>Maintain backward compatibility for existing API contracts</li>
            </ul>
            
            <strong>Example Migration:</strong>
            <div class="code-block">
                <pre># BEFORE - track.py line 94-95
meal_tracking_data.append(meal_record.model_dump())

# AFTER
meal_id = await db_service.create_meal(user_id, request)
meal_record = await db_service.get_meal_by_id(meal_id)</pre>
            </div>
        </div>

        <div class="phase-card">
            <div class="phase-header">
                <div class="phase-number">4</div>
                <h3>Authentication Integration üîê</h3>
            </div>
            
            <div class="highlight">
                <strong>Current Challenge:</strong> Non-auth routes don't require authentication
            </div>
            
            <strong>Solutions:</strong>
            <ul>
                <li><strong>Option A:</strong> Make authentication required for all routes</li>
                <li><strong>Option B:</strong> Add optional user context with anonymous fallback</li>
                <li><strong>Option C:</strong> Use session-based temporary user IDs</li>
            </ul>
            
            <strong>Recommended Approach (Option B):</strong>
            <div class="code-block">
                <pre>async def get_user_context(request: Request) -> Optional[str]:
    """Extract user ID from JWT token if present"""
    try:
        # Extract from Authorization header
        user_id = extract_user_from_jwt(request)
        return user_id
    except:
        return None  # Anonymous user

async def track_meal(request: MealTrackingRequest, req: Request):
    user_id = await get_user_context(req) or "anonymous"
    # Continue with database operations...</pre>
            </div>
        </div>

        <div class="phase-card">
            <div class="phase-header">
                <div class="phase-number">5</div>
                <h3>Migration Path üìã</h3>
            </div>
            
            <strong>Implementation Order:</strong>
            <ol>
                <li><strong>Database Schema</strong> - Create new tables</li>
                <li><strong>Service Extensions</strong> - Add database methods</li>
                <li><strong>Track Routes</strong> - Highest priority (most used)</li>
                <li><strong>Plan Routes</strong> - Second priority (complex operations)</li>
                <li><strong>Reminder Routes</strong> - Third priority</li>
                <li><strong>Product Routes</strong> - Keep cache-only (external API optimization)</li>
            </ol>
            
            <strong>Migration Strategy:</strong>
            <ul>
                <li><strong>Gradual rollout</strong> - Switch one route module at a time</li>
                <li><strong>Backward compatibility</strong> - Keep existing API responses identical</li>
                <li><strong>Data preservation</strong> - Export existing Redis cache data before migration</li>
                <li><strong>Testing</strong> - Use existing integration tests to validate functionality</li>
            </ul>
        </div>

        <div class="phase-card">
            <div class="phase-header">
                <div class="phase-number">6</div>
                <h3>Production Benefits üöÄ</h3>
            </div>
            
            <div class="benefits">
                <h4>Post-Implementation Advantages:</h4>
                <ul>
                    <li><strong>Data Persistence</strong> - No data loss on application restart</li>
                    <li><strong>User Isolation</strong> - Proper multi-user support</li>
                    <li><strong>Analytics Ready</strong> - Historical data for insights</li>
                    <li><strong>Scalability</strong> - Database-backed operations</li>
                    <li><strong>Backup & Recovery</strong> - Standard database backup procedures</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üìà Implementation Summary</h2>
        
        <div class="status-grid">
            <div class="status-card status-connected">
                <strong>Estimated Implementation Time</strong><br>
                2-3 days
            </div>
            <div class="status-card status-cache">
                <strong>Risk Level</strong><br>
                Medium (requires careful migration planning)
            </div>
            <div class="status-card status-memory">
                <strong>Dependencies</strong><br>
                Existing DatabaseService, Redis remains for caching
            </div>
        </div>
        
        <p style="font-size: 1.1em; text-align: center; margin-top: 30px; font-weight: 500;">
            This plan provides a clear path from the current cache-based storage to a full database-backed architecture 
            while maintaining API compatibility and adding proper user context management.
        </p>
    </div>

    <div class="meta-info">
        <strong>Report Details:</strong><br>
        Generated: September 1, 2025<br>
        Analysis based on: DietIntel API codebase inspection<br>
        Current Database: SQLite (dietintel.db) with users and user_sessions tables<br>
        Current Cache: Redis (localhost:6379) - Active and responding<br>
        Report Location: reports/database_implementation_plan.html
    </div>
</body>
</html>